<!DOCTYPE html>
<html>
<head>
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

	<script
		src="https://code.jquery.com/jquery-3.4.1.min.js"
		integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
		crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>

		<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.0/css/all.css" integrity="sha384-lKuwvrZot6UHsBSfcMvOkWwlCMgc0TaWr+30HWe3a4ltaBwTZhyTEggF5tJv8tbt" crossorigin="anonymous">

	<title>London Status Page</title>
</head>
<style>
	html { overflow-y: hidden; }
</style>
<body>
	<div id="top"></div>
	<div id=ug class=container-fluid>
		<h3>Knightsbridge Underground Arrivals <img src='images/tube-partner.png' width='30' height='25' align='middle'><span style='float:right;' class=time></span></h3>
		<div id=knightsbridgeugdepartures class=container-fluid></div>
		<h3>Sloane Square Underground Arrivals <img src='images/tube-partner.png' width='30' height='25' align='middle'></span></h3>
		<div id=sloanesquareugdepartures class=container-fluid></div>
		<h3>Underground Status</h3>
		<div id=ugstatus class=container-fluid></div>
	</div>
	<div id=commute class=container-fluid >
		<h3>Commute Times <i class="fas fa-route"></i><span style='float:right;' class=time></span></h3>
		<table class="table">
		  <thead>
		    <tr>
		      <th scope="col">Destination</th>
		      <th scope="col"><i class="fas fa-bicycle"></i></th>
		      <th scope="col"><i class="fas fa-subway"></i></th>
		      <th scope="col"><i class="fas fa-walking"></i></th>
		    </tr>
		  </thead>
		  <tbody>
		    <tr>
		      <th scope="row">KCL, Strand</th>
		      <td id=strand_bike><div class="spinner-grow spinner-grow-sm text-secondary" role="status"></div></td>
		      <td id=strand_transit><div class="spinner-grow spinner-grow-sm text-secondary" role="status"></div></td>
		      <td id=strand_walk><div class="spinner-grow spinner-grow-sm text-secondary" role="status"></div></td>
		    </tr>
		    <tr>
		      <th scope="row">KCL, Waterloo</th>
		      <td id=waterloo_bike><div class="spinner-grow spinner-grow-sm text-secondary" role="status"></div></td>
		      <td id=waterloo_transit><div class="spinner-grow spinner-grow-sm text-secondary" role="status"></div></td>
		      <td id=waterloo_walk><div class="spinner-grow spinner-grow-sm text-secondary" role="status"></div></td>
		    </tr>
		    <tr>
		      <th scope="row">KCL, Maughan</th>
		      <td id=maughan_bike><div class="spinner-grow spinner-grow-sm text-secondary" role="status"></div></td>
		      <td id=maughan_transit><div class="spinner-grow spinner-grow-sm text-secondary" role="status"></div></td>
		      <td id=maughan_walk><div class="spinner-grow spinner-grow-sm text-secondary" role="status"></div></td>
		    </tr>
		    <tr>
		      <th scope="row">Camden Market</th>
		      <td id=camden_bike><div class="spinner-grow spinner-grow-sm text-secondary" role="status"></div></td>
		      <td id=camden_transit><div class="spinner-grow spinner-grow-sm text-secondary" role="status"></div></td>
		      <td id=camden_walk><div class="spinner-grow spinner-grow-sm text-secondary" role="status"></div></td>
		    </tr>
		    <tr>
		      <th scope="row">Kingly Court</th>
		      <td id=kingly_bike><div class="spinner-grow spinner-grow-sm text-secondary" role="status"></div></td>
		      <td id=kingly_transit><div class="spinner-grow spinner-grow-sm text-secondary" role="status"></div></td>
		      <td id=kingly_walk><div class="spinner-grow spinner-grow-sm text-secondary" role="status"></div></td>
		    </tr>
		    <tr>
		      <th scope="row">Covent Garden</th>
		      <td id=coventgarden_bike><div class="spinner-grow spinner-grow-sm text-secondary" role="status"></div></td>
		      <td id=coventgarden_transit><div class="spinner-grow spinner-grow-sm text-secondary" role="status"></div></td>
		      <td id=coventgarden_walk><div class="spinner-grow spinner-grow-sm text-secondary" role="status"></div></td>
		    </tr>
		    <tr>
		      <th scope="row">South Kensington</th>
		      <td id=southken_bike><div class="spinner-grow spinner-grow-sm text-secondary" role="status"></div></td>
		      <td id=southken_transit><div class="spinner-grow spinner-grow-sm text-secondary" role="status"></div></td>
		      <td id=southken_walk><div class="spinner-grow spinner-grow-sm text-secondary" role="status"></div></td>
		    </tr>
		    <tr>
		      <th scope="row">Heathrow Airport</th>
		      <td id=heathrow_bike>-</td>
		      <td id=heathrow_transit><div class="spinner-grow spinner-grow-sm text-secondary" role="status"></div></td>
		      <td id=heathrow_walk>-</td>
		    </tr>
		    <tr>
		      <th scope="row">Gatwick Airport</th>
		      <td id=gatwick_bike>-</td>
		      <td id=gatwick_transit><div class="spinner-grow spinner-grow-sm text-secondary" role="status"></div></td>
		      <td id=gatwick_walk>-</td>
		    </tr>
		  </tbody>
		</table>
	</div>
	<div id=busDepartures class=container-fluid >
		<h3>Local Bus Departures <img src='images/buses-partner.png' width='30' height='25' align='middle'><span style='float:right;' class=time></span></h3>
		<div class=row>
			<div class="col-sm-6" id=busKM></div>
			<div class="col-sm-6" id=busKL></div>
		</div>
		<div id="mid"></div>
		<h3>Bikes <img src='images/sc-partner.png' height='25' align='middle'></span></h3>
		<div class=row>
			<div class="col-sm-12" id=bikes_BikePoints_143></div>
			<div class="col-sm-12" id=bikes_BikePoints_211></div>
		</div>
	</div>
	<div id=weather class=container-fluid >
		<h3>Weather Updates <span style='float:right;' class=time></h3>
		<div id=currentWeather class=container-fluid></div>
		<div id=futureWeather class=container-fluid></div>
		<div><iframe width="100%" height="450" src="https://embed.windy.com/embed2.html?lat=52.036&lon=-0.176&zoom=6&level=surface&overlay=radar&menu=&message=true&marker=&calendar=12&pressure=&type=map&location=coordinates&detail=&detailLat=51.482&detailLon=-0.125&metricWind=default&metricTemp=%C2%B0F&radarRange=-6" frameborder="0"></iframe></div>
	</div>
	<div id="bottom"></div>
</body>

<!-- The core Firebase JS SDK is always required and must be listed first -->
<script src="https://www.gstatic.com/firebasejs/6.6.2/firebase-app.js"></script>

<!-- TODO: Add SDKs for Firebase products that you want to use
     https://firebase.google.com/docs/web/setup#available-libraries -->
	<script src="https://www.gstatic.com/firebasejs/6.6.2/firebase-functions.js"></script>

<script>
	// Your web app's Firebase configuration
	var firebaseConfig = {
		apiKey: "AIzaSyBe64SoekRLaf4lKoBd62OCXmsb6SQqh3Y",
		authDomain: "londonstatus-74ab5.firebaseapp.com",
		databaseURL: "https://londonstatus-74ab5.firebaseio.com",
		projectId: "londonstatus-74ab5",
		storageBucket: "",
		messagingSenderId: "37034092587",
		appId: "1:37034092587:web:93dd3c9dea1671cef3626e"
	};

	// Initialize Firebase
	firebase.initializeApp(firebaseConfig);
	var functions = firebase.functions();

	function compareArrivals(a, b) {
		return a.timeToStation - b.timeToStation;
	}

	function updateKnightsbridgeUG () {
		var updateStoppoint = firebase.functions().httpsCallable('updateStoppoint');
		updateStoppoint({stopID: "940GZZLUKNB"}).then(function(result) {
			var output = JSON.parse(result.data);

			var platform1 = [];
			var platform2 = [];

			for (var i = 0; i < output.length; i++) {
				if(output[i].platformName == "Eastbound - Platform 1") {
					platform1.push(output[i]);
				} else {
					platform2.push(output[i]);
				}
			}

			platform1.sort(compareArrivals);
			platform2.sort(compareArrivals);

			var html = "<div class='container-fluid'><div class='row'><div class='col'><h4>Platform 1 <small class='text-muted'>Eastbound</small></h4><table width='100%'><tbody>";

			for (var i = 0; i < Math.min(platform1.length,6); i++) {
				html += "<tr><td style='width:140px;'><span class=\"badge badge-pill badge-secondary\" style=\"background-color:" + getLineColor(platform1[i].lineId) + "\">" + platform1[i].lineName + " </span></td><td>"+platform1[i].towards+"</td><td style='text-align:right;'><b>"+Math.round(platform1[i].timeToStation/60)+" mins</b></td></tr>";
			}

			html += "</tbody></table></div><div class='col'><h4>Platform 2 <small class='text-muted'>Westbound</small></h4><table width='100%'><tbody>";

			for (var i = 0; i < Math.min(platform2.length,6); i++) {
				html += "<tr><td style='width:140px;'><span class=\"badge badge-pill badge-secondary\" style=\"background-color:" + getLineColor(platform2[i].lineId) + "\">" + platform2[i].lineName + " </span></td><td>"+platform2[i].towards+"</td><td style='text-align:right;'><b>"+Math.round(platform2[i].timeToStation/60)+" mins</b></td></tr>";
			}

			html += "</tbody></table></div></div></div>";

			$("#knightsbridgeugdepartures").html(html);

		});

	}

	function getLineColor (lineID) {
		switch (lineID) {
			case "district":
				return "rgb(0,125,50)";
				break;
			case "circle":
				return "rgb(255,211,41)";
				break;
			case "piccadilly":
				return "rgb(0,25,168)";
				break;
			case "hammersmith-city":
				return "rgb(244,169,190)";
				break;
			default:
				return "#6c757d";
				break;
		}
	}

	function updateSloaneSquareUG () {
		var updateStoppoint = firebase.functions().httpsCallable('updateStoppoint');
		updateStoppoint({stopID: "940GZZLUSSQ"}).then(function(result) {
			var output = JSON.parse(result.data);

			var platform1 = [];
			var platform2 = [];

			for (var i = 0; i < output.length; i++) {
				if(output[i].platformName == "Westbound - Platform 1") {
					platform1.push(output[i]);
				} else {
					platform2.push(output[i]);
				}
			}

			platform1.sort(compareArrivals);
			platform2.sort(compareArrivals);

			var html = "<div class='container-fluid'><div class='row'><div class='col'><h4>Platform 1 <small class='text-muted'>Westbound</small></h4><table width='100%'><tbody>";

			for (var i = 0; i < Math.min(platform1.length,6); i++) {
				html += "<tr><td style='width:140px;'><span class=\"badge badge-pill badge-secondary\" style=\"background-color:" + getLineColor(platform1[i].lineId) + "\">" + platform1[i].lineName + " </span></td><td>"+platform1[i].towards+"</td><td style='text-align:right;'><b>"+Math.round(platform1[i].timeToStation/60)+" mins</b></td></tr>";
			}

			html += "</tbody></table></div><div class='col'><h4>Platform 2 <small class='text-muted'>Eastbound</small></h4><table width='100%'><tbody>";

			for (var i = 0; i < Math.min(platform2.length,6); i++) {
				html += "<tr><td style='width:140px;'><span class=\"badge badge-pill badge-secondary\" style=\"background-color:" + getLineColor(platform2[i].lineId) + "\">" + platform2[i].lineName + " </span></td><td>"+platform2[i].towards+"</td><td style='text-align:right;'><b>"+Math.round(platform2[i].timeToStation/60)+" mins</b></td></tr>";
			}

			html += "</tbody></table></div></div></div>";

			$("#sloanesquareugdepartures").html(html);

		});

	}

	function updateUGStatus() {
		function compareStatuses (a, b) {
			return a.minStatus - b.minStatus;
		}

		var updateUndergroundStatus = firebase.functions().httpsCallable('updateUndergroundStatus');
		updateUndergroundStatus({}).then(function(result) {
			var output = JSON.parse(result.data);


			var statusHTML = "<table class='table'><tbody>";

			var impactedLines = 0;

			for (var i = 0; i < output.length; i++) {
				var min = Infinity;
				for (var j = 0; j < output[i].lineStatuses.length; j++) {
					min = Math.min(output[i].lineStatuses[j].statusSeverity, min);
				}
				output[i].minStatus = min;
			}

			output.sort(compareStatuses);

			for (var i = 0; i < output.length; i++) {

				if(output[i].minStatus < 4) {
					statusHTML += "<tr class='table-primary'>";
					impactedLines++;
				} else if(output[i].minStatus < 7) {
					statusHTML += "<tr class='table-danger'>";
					impactedLines++;
				} else if(output[i].minStatus < 10) {
					statusHTML += "<tr class='table-warning'>";
					impactedLines++;
				} else {
					continue;
				}

				statusHTML += "<th>"+output[i].name+"</th><td>";

				for (var j = 0; j < output[i].lineStatuses.length; j++) {
					statusHTML += "<p>"+output[i].lineStatuses[j].statusSeverityDescription+"</p>";
				}

				statusHTML += "</td>";

				if(output[i].lineStatuses[0].reason != undefined) {
					statusHTML += "<td>"+output[i].lineStatuses[0].reason.substring(output[i].lineStatuses[0].reason.indexOf(":")+2)+"</td></tr>";
				} else {
					statusHTML += "<td></td></tr>";
				}
			}

			statusHTML += "</tbody></table>";

			if(impactedLines > 0) {
				statusHTML += "<p><strong>There is a good service on all other London Undergrond Lines.</strong></p>";
			} else {
				statusHTML += "<p><strong>There is a good service on all London Undergrond Lines.</strong></p>";
			}

			$("#ugstatus").html(statusHTML);

		});
		
	}

	function getSecondsUntilArrival(a) {
		var timeString;
		if(a["lt4:etd"]["_text"] == "On time") {
			timeString = a["lt4:std"]["_text"];
		} else {
			timeString = a["lt4:etd"]["_text"];
		}

		if(timeString == "Delayed") {
			return 100000;
		}
		
		var currentDate = new Date();
		var etdDate = new Date();

		if(timeString.substring(0,2)< currentDate.getHours() && currentDate.getHours()==23 && currentDate.getMinutes()>30) {
			etdDate.setDate(currentDate.getDate()+1);
		}

		etdDate.setHours(timeString.substring(0,2));
		etdDate.setMinutes(timeString.substring(3,5));
		etdDate.setSeconds(0);
		etdDate.setMilliseconds(0);

		var secondsUntil = (etdDate-currentDate)/1000;
		return secondsUntil;

	}

	function compareNRArrivalTimes(a,b) {
		return getSecondsUntilArrival(a) - getSecondsUntilArrival(b);
	}

	function updateVauxhallNR () {
		var addMessage = firebase.functions().httpsCallable('updateVauxhallNR');
		addMessage({}).then(function(result) {
			var output = JSON.parse(result.data);
			var stationMessage = "";
			if(output["soap:Envelope"]["soap:Body"]["GetDepBoardWithDetailsResponse"]["GetStationBoardResult"]["lt4:nrccMessages"] == undefined) {
				stationMessage = undefined;
			} else if (output["soap:Envelope"]["soap:Body"]["GetDepBoardWithDetailsResponse"]["GetStationBoardResult"]["lt4:nrccMessages"]["lt:message"]["_text"] != undefined)  {
				stationMessage += "<div class='alert alert-danger' role='alert'>" + output["soap:Envelope"]["soap:Body"]["GetDepBoardWithDetailsResponse"]["GetStationBoardResult"]["lt4:nrccMessages"]["lt:message"]["_text"] + "</div>";
			} else {
				for (var i = 0; i < output["soap:Envelope"]["soap:Body"]["GetDepBoardWithDetailsResponse"]["GetStationBoardResult"]["lt4:nrccMessages"]["lt:message"].length; i++) {
					stationMessage += "<div class='alert alert-danger' role='alert'>" + output["soap:Envelope"]["soap:Body"]["GetDepBoardWithDetailsResponse"]["GetStationBoardResult"]["lt4:nrccMessages"]["lt:message"][i]["_text"]+"</div>";
				}
			}
			output = output["soap:Envelope"]["soap:Body"]["GetDepBoardWithDetailsResponse"]["GetStationBoardResult"]["lt5:trainServices"]["lt5:service"];

			var html = "<h3>Vauxhall National Rail Departures <img src='images/nationalrail.png' width='40' height='25' align='middle'><span style='float:right;' class=time></span></h3>";

			if(stationMessage != undefined) {
				html += stationMessage;
			}

			html += "<div class='container-fluid'><table class='table table-sm' width='100%'><thead><tr><th scope=col>Time</th><th scope=col>Destination</th><th scope=col>Platform</th><th scope=col>Status</th><th scope=col style='text-align:right;'>ETA</th></tr></thead><tbody>";

			output.sort(compareNRArrivalTimes)

			for (var i = 0; i < output.length; i++) {
				var etdHTML = "";
				var timeString = "";
				if (output[i]["lt4:etd"]["_text"] == "Cancelled") {
					continue;
				}
				else if (output[i]["lt4:etd"]["_text"] == "On time") {
					etdHTML = "<p class='text-success' style='margin-bottom:0px;'>"+output[i]["lt4:std"]["_text"]+"</p>";
					timeString = output[i]["lt4:std"]["_text"];
				} 
				// else if(output[i]["lt4:etd"]["_text"] == "Delayed") {
				// 	etdHTML = "<p class='text-danger'><s>"+output[i]["lt4:std"]["_text"]+"</s></p>";
				// } 
				else {
					etdHTML = "<p class='text-danger' style='margin-bottom:0px;'>"+output[i]["lt4:etd"]["_text"]+" <small class='text-muted'><s>"+output[i]["lt4:std"]["_text"]+"</s></small></p>";
					timeString = output[i]["lt4:etd"]["_text"];
				}

				var currentDate = new Date();
				var etdDate = new Date();

				if(timeString.substring(0,2)< currentDate.getHours()  && currentDate.getHours()==23 && currentDate.getMinutes()>30) {
					etdDate.setDate(currentDate.getDate()+1);
				}

				etdDate.setHours(timeString.substring(0,2));
				etdDate.setMinutes(timeString.substring(3,5));
				etdDate.setSeconds(0);
				etdDate.setMilliseconds(0);

				var minutesUntil = (etdDate-currentDate)/1000;
				if(minutesUntil < 30) {
					minutesUntil = "Due";
				} else {
					minutesUntil = ""+Math.round(minutesUntil/60)+" mins";
				}

				if(minutesUntil == "NaN mins") {
					minutesUntil = "Unknown";
				}

				var subsequentPointsString = "Calling at ";
				var subsequentPointsArray = output[i]["lt5:subsequentCallingPoints"]["lt4:callingPointList"]["lt4:callingPoint"];

				if(subsequentPointsArray.length == undefined) {
					subsequentPointsString += output[i]["lt5:destination"]["lt4:location"]["lt4:locationName"]["_text"] +" only."
				}

				for (var j = 0; j < subsequentPointsArray.length; j++) {
					subsequentPointsString += subsequentPointsArray[j]["lt4:locationName"]["_text"];
					if(j == subsequentPointsArray.length-1) {
						subsequentPointsString += ".";
					} else if (j == subsequentPointsArray.length - 2) {
						subsequentPointsString += ", and ";
					} else {
						subsequentPointsString += ", "
					}
				}

				var delayReason;
				if(output[i]["lt4:delayReason"] == undefined) {
					delayReason = "";
				} else {
					delayReason = output[i]["lt4:delayReason"]["_text"];
				}

				var platform;
				if(output[i]["lt4:platform"] == undefined) {
					platform = "";
				} else {
					platform = "Platform "+output[i]["lt4:platform"]["_text"];
				}

				html += "<tr><td>"+etdHTML+"</td><td>"+output[i]["lt5:destination"]["lt4:location"]["lt4:locationName"]["_text"]+"</td><td>"+platform+"</td><td width='30%'><marquee>"+delayReason+"</marquee></td><td style='text-align:right;'>"+minutesUntil+"</td></tr>"

				// if(output[i]["lt4:delayReason"] != undefined) {
					// html += "<tr valign='height:5px;'><td colspan=5 valign='top'><small class='text-muted'>"+output[i]["lt4:delayReason"]["_text"]+"</small></td></tr>";
				// }
				html += "<tr><td colspan=5 style='vertical-align:top;border-top-width:0px'><small class='text-muted'>"+subsequentPointsString+"</small></td></tr>";
				
			}

			html += "</tbody></table></div>";

			$("#vauxhallnr").html(html);
		});
	}

	function updateBus (stopID) {
		var addMessage = firebase.functions().httpsCallable('updateStoppoint');
		addMessage({stopID: stopID}).then(function(result) {
			var output = JSON.parse(result.data);
			if (output.length == 0){
				return;
			}

			if(output[0].modeName == "river-bus") {
				output[0].platformName = "River"
			}

			var cardHTML = "<div class='card' style='width: 100%;margin-bottom:20px;'><div class='card-header'><h3><span class='badge badge-danger'>"+output[0].platformName+"</span></h3> <h6>Towards " + output[0].towards + "</h6></div><div class='card-body'>";

			var departuresDictionary = {};

			for (var i = 0; i < output.length; i++) {
				if(departuresDictionary[output[i].lineName + " to " + output[i].destinationName] == undefined) {
					departuresDictionary[output[i].lineName + " to " + output[i].destinationName] = [];
				}
				departuresDictionary[output[i].lineName + " to " + output[i].destinationName].push(output[i]);
			}

			for (var index in departuresDictionary) {
				departuresDictionary[index].sort(compareArrivals);
				cardHTML += "<p><b>"+index+"</b><br>";
				for (var j = 0; j < departuresDictionary[index].length; j++) {
					cardHTML += ""+Math.max(Math.round(departuresDictionary[index][j].timeToStation/60),0)+" mins";
					if(j == departuresDictionary[index].length-1) {
						cardHTML += ". </p>";
					} else {
						cardHTML += ", ";
					}
				}
			}


			    
			cardHTML += "</div></div>"

			
			$("#bus"+output[0].platformName).html(cardHTML);
		});
	}

	function updateAllBuses () {
		var stopIDs = [
			"490011097S",
			"490011097N"
		];

		for (var i = 0; i < stopIDs.length; i++) {
			updateBus(stopIDs[i]);
		}
	}

	function updateBikes (bikePointID) {
		var updateBikepoint = firebase.functions().httpsCallable('updateBikepoint');
		updateBikepoint({bikePointID: bikePointID}).then(function(result) {
			var output = JSON.parse(result.data);
			if (output.length == 0){
				return;
			}

			var cardHTML = "<div class='card' style='width: 100%;margin-bottom:20px;'><div class='card-header'><h5>" + output.commonName + "</h5></div><div class='card-body'>";

			var availableBikes;
			var emptyDocks;

			for (var i = 0; i < output.additionalProperties.length; i++) {
				if(output.additionalProperties[i].key == "NbBikes") {
					availableBikes = parseInt(output.additionalProperties[i].value);
				} else if(output.additionalProperties[i].key == "NbEmptyDocks") {
					emptyDocks = parseInt(output.additionalProperties[i].value);
				}
			}

			var totalDocks = availableBikes + emptyDocks;

			var percentAvailable = availableBikes / totalDocks * 100;

			cardHTML += "<div><p style=\"width:100%\">Available Bikes<span style=\"float:right\">Empty Docks</span></p><h4 style=\"width:100%\">" + availableBikes + "<span style=\"float:right\">" + emptyDocks + "</span></h4></div><div class=\"progress\"><div class=\"progress-bar bg-danger\" role=\"progressbar\" style=\"width: " + percentAvailable + "%\" aria-valuenow=\"" + percentAvailable + "\" aria-valuemin=\"0\" aria-valuemax=\"100\"></div></div></div></div>";
			
			$("#bikes_" + output.id).html(cardHTML);
		});
	}

	function updateAllBikes () {
		var bikePointIDs = [
			"BikePoints_143",
			"BikePoints_211"
		];

		for (var i = 0; i < bikePointIDs.length; i++) {
			updateBikes(bikePointIDs[i]);
		}
		
	}

	function updateWeather () {
		var updateFutureWeather = firebase.functions().httpsCallable('updateFutureWeather');
		var updateCurrentWeather = firebase.functions().httpsCallable('updateCurrentWeather');
		updateFutureWeather({}).then(function(result) {
			var output = JSON.parse(result.data);
			var weatherHTML = "<h6>Future Projections</h6><table class='table table-sm'><thead><tr><th scope='col'>Time</th><th scope='col'>Temperature</th><th scope='col'>Conditions</th><th scope='col'>Wind</th></tr></thead><tbody>";

			for (var i = 0; i < Math.min(output.list.length,9); i++) {
				var weatherDate = new Date(output.list[i].dt_txt);
				weatherHTML+= "<tr><td>"+weatherDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})+"</td><td>"+Math.round(output.list[i].main.temp)+"°F</td><td>"+output.list[i].weather[0].description+"<img src=http://openweathermap.org/img/wn/" + output.list[i].weather[0].icon + ".png></td><td>Wind "+Math.round(output.list[i].wind.speed)+" mph</td></tr>";
			}

			weatherHTML += "</tbody></table>";

			$("#futureWeather").html(weatherHTML);
		});

		updateCurrentWeather({}).then(function(result) {
			var output = JSON.parse(result.data);
			var weatherHTML = "<h6>Current Weather</h6><div class=row><div><h1 class='display-1'>"+Math.round(output.main.temp)+"°F</h1><p>High "+Math.round(output.main.temp_max)+", Low "+Math.round(output.main.temp_min)+"</p></div><div><img src=http://openweathermap.org/img/wn/" + output.weather[0].icon + ".png>";
		

			$("#currentWeather").html(weatherHTML);
		});
	}

	function updateCommute() {
		var getDirections = firebase.functions().httpsCallable('getDirections');

		var queries = [
			{ id: "strand_walk", origin: "SW1X 0HT", destination: "King's College London, Strand", mode: "walking" },
			{ id: "strand_bike", origin: "SW1X 0HT", destination: "King's College London, Strand", mode: "bicycling" },
			{ id: "strand_transit", origin: "SW1X 0HT", destination: "King's College London, Strand", mode: "transit" },
			{ id: "waterloo_walk", origin: "SW1X 0HT", destination: "King's College London, Waterloo", mode: "walking" },
			{ id: "waterloo_bike", origin: "SW1X 0HT", destination: "King's College London, Waterloo", mode: "bicycling" },
			{ id: "waterloo_transit", origin: "SW1X 0HT", destination: "King's College London, Waterloo", mode: "transit" },
			{ id: "maughan_walk", origin: "SW1X 0HT", destination: "King's College London, Maughan Library", mode: "walking" },
			{ id: "maughan_bike", origin: "SW1X 0HT", destination: "King's College London, Maughan Library", mode: "bicycling" },
			{ id: "maughan_transit", origin: "SW1X 0HT", destination: "King's College London, Maughan Library", mode: "transit" },
			{ id: "camden_walk", origin: "SW1X 0HT", destination: "Camden Market", mode: "walking" },
			{ id: "camden_bike", origin: "SW1X 0HT", destination: "Camden Market", mode: "bicycling" },
			{ id: "camden_transit", origin: "SW1X 0HT", destination: "Camden Market", mode: "transit" },
			{ id: "heathrow_transit", origin: "SW1X 0HT", destination: "Heathrow Terminal 5", mode: "transit" },
			{ id: "gatwick_transit", origin: "SW1X 0HT", destination: "Gatwick Airport South", mode: "transit" },
			{ id: "kingly_walk", origin: "SW1X 0HT", destination: "Kingly Court", mode: "walking" },
			{ id: "kingly_bike", origin: "SW1X 0HT", destination: "Kingly Court", mode: "bicycling" },
			{ id: "kingly_transit", origin: "SW1X 0HT", destination: "Kingly Court", mode: "transit" },
			{ id: "coventgarden_bike", origin: "SW1X 0HT", destination: "Covent Garden", mode: "walking" },
			{ id: "coventgarden_transit", origin: "SW1X 0HT", destination: "Covent Garden", mode: "bicycling" },
			{ id: "coventgarden_walk", origin: "SW1X 0HT", destination: "Covent Garden", mode: "transit" },
			{ id: "southken_bike", origin: "SW1X 0HT", destination: "South Kensington Station", mode: "walking" },
			{ id: "southken_transit", origin: "SW1X 0HT", destination: "South Kensington Station", mode: "bicycling" },
			{ id: "southken_walk", origin: "SW1X 0HT", destination: "South Kensington Station", mode: "transit" }
		];



		for(var i = 0; i < queries.length; i++) {
			getDirections({
				origin: queries[i].origin,
				destination: queries[i].destination,
				mode: queries[i].mode,
				id: queries[i].id
			}).then(function(result) {
				var output = JSON.parse(result.data.body);
				$("#" + result.data.id).html("<p>" + output.routes[0].legs[0].duration.text + "</p>");

				var isTransit = false;
				var stepsHTMLStrings = [];
				for(var j = 0; j < output.routes[0].legs[0].steps.length; j++) {
					if(output.routes[0].legs[0].steps[j].travel_mode == "WALKING") {
						if(output.routes[0].legs[0].steps[j].duration.value > 200) {
							stepsHTMLStrings.push("<i class=\"fas fa-walking\"></i> " + output.routes[0].legs[0].steps[j].duration.text);

						}
					} else if(output.routes[0].legs[0].steps[j].travel_mode == "TRANSIT") {
						isTransit = true;
						stepsHTMLStrings.push("<img height=20 src=\"https://" + output.routes[0].legs[0].steps[j].transit_details.line.vehicle.local_icon + "\"> <span class=\"badge badge-pill badge-secondary\" style=\"background-color:" + output.routes[0].legs[0].steps[j].transit_details.line.color + ";color:" + output.routes[0].legs[0].steps[j].transit_details.line.text_color + "\">" + output.routes[0].legs[0].steps[j].transit_details.line.name + " </span> " + output.routes[0].legs[0].steps[j].duration.text);
					}
				}

				if(isTransit) {
					$("#" + result.data.id).append(stepsHTMLStrings.join(" <i class=\"fas fa-arrow-right\"></i> "));
				}
			});
		}
	}

	var currentScrollTimeout;

	function goToBottom() {
	    document.querySelector('#bottom').scrollIntoView({ 
		  behavior: 'smooth' 
		});    
	};

	function goToTop() {
	    document.querySelector('#top').scrollIntoView({ 
		  behavior: 'smooth' 
		});
	};

	function goToMiddle() {
	    document.querySelector('#mid').scrollIntoView({ 
		  behavior: 'smooth' 
		});
	    currentScrollTimeout = setTimeout( function () { goToBottom(); }, 3333 );
	};


	var currentTimeout;

	function carousel0 () {
		$("#commute").fadeOut(300);
		$("#busDepartures").fadeOut(300, function() {
			$("#weather").fadeIn(300);
		});
		$("#ug").fadeOut(300);
		currentTimeout = setTimeout(function(){ carousel1(); }, 10000);
		currentScrollTimeout = setTimeout( function () { goToBottom(); }, 5000 );
		goToTop();
	}

	function carousel1 () {
		$("#weather").fadeOut(300, function() {
			$("#ug").fadeIn(300);
		});
		$("#commute").fadeOut(300);
		$("#busDepartures").fadeOut(300);
		
		currentTimeout = setTimeout(function(){ carousel2(); }, 10000);
		currentScrollTimeout = setTimeout( function () { goToBottom(); }, 5000 );
		goToTop();
	}

	function carousel2 () {
		$("#weather").fadeOut(300);
		$("#busDepartures").fadeOut(300);
		$("#ug").fadeOut(300, function() {
			$("#commute").fadeIn(300);
		});
		currentTimeout = setTimeout(function(){ carousel3(); }, 10000);
		currentScrollTimeout = setTimeout( function () { goToBottom(); }, 5000 );
		goToTop();	}

	function carousel3 () {
		$("#weather").fadeOut(300);
		$("#commute").fadeOut(300, function() {
			$("#busDepartures").fadeIn(300);
		});
		$("#ug").fadeOut(300);
		currentTimeout = setTimeout(function(){ carousel0(); }, 10000);
		currentScrollTimeout = setTimeout( function () { goToMiddle(); }, 3333 );	
		goToTop();
	}

	function updateAll () {
		updateKnightsbridgeUG();
		updateSloaneSquareUG();
		updateUGStatus();
		updateAllBuses();
		updateAllBikes();
		updateWeather();
		updateCommute();
	}

	updateAll();
	carousel0();
	setInterval(updateAll, 50000);

	function updateTime() {
		$(".time").html(new Date().toLocaleTimeString());
	}
	setInterval(updateTime, 1000);

	setTimeout(function(){ location.reload(); }, 3600000);

	function clearTimeouts() {
		clearTimeout(currentTimeout);
		clearTimeout(currentScrollTimeout);
	}

	$(document).keypress(function(event){
		if (event.keyCode == 119) { // 'w' weather
			clearTimeouts();
			carousel0();
		} else if (event.keyCode == 99) { // 'c' commute
			clearTimeouts();
			carousel2();
		} else if (event.keyCode == 117) { // 'u' london underground
			clearTimeouts();
			carousel1();
		} else if (event.keyCode == 98) { // 'b' london bus
			clearTimeouts();
			carousel3();
		}	
	});

</script>

</html>